import{a as re,r as u,G as ae,o as ce,c as p,b as o,q as I,h as ie,u as ue,f as N,F as ve,g as de,t as L,w as ge,k as pe,y as me,l as m,m as fe,n as he,_ as ye}from"./index-f73cffae.js";import{g as _e}from"./musicApi-3bd1a4e5.js";import{l as x,g as ke}from"./giftStateManager-5d5d191e.js";import{A as we}from"./arrow-left-63fa745a.js";import"./createLucideIcon-8fa92933.js";const be={class:"music-player-page"},Le={class:"top-nav"},xe={class:"main-content"},Te={class:"cover-info-section"},Me=["src","alt"],$e={key:0,class:"loading-lyrics"},Pe={key:1,class:"no-lyrics"},Se={key:2,class:"lyrics-content"},Ce={key:2,class:"music-info"},Be={class:"music-title"},Ee={class:"music-artist"},De={class:"progress-container"},Ie={class:"time-current"},Ne={class:"time-total"},Re={class:"player-controls"},ze={key:0,width:"32",height:"32",viewBox:"0 0 24 24",fill:"white",stroke:"none"},Ue={key:1,width:"32",height:"32",viewBox:"0 0 24 24",fill:"white",stroke:"none"},We=["src"],Ve=re({__name:"MusicPlayerPage",setup(Ae){const R=pe(),z=me(),a=u(null),b=u(!1),_=u(105),k=u(200),f=u(),K=u(),M=u(),w=u(!1),T=u(0),U=ae(()=>w.value?T.value:k.value>0?_.value/k.value*100:0),h=u(!1),y=u(-1),d=u([]),$=u(!1),P=u(!1),S=u(null),j=t=>{const e=[];let s="";const n=[];let v=0;t.forEach(r=>{const c=r.word;for(let g=0;g<c.length;g++)n.push({char:v+g,time:r.start_s});s+=c,v+=c.length}),console.log("完整歌词文本:",s),console.log("字符时间映射总数:",n.length);const i=s.split(`
`);let l=0;return i.forEach((r,c)=>{const g=r.trim();if(!g){l+=r.length+1;return}if(V(g)){console.log("跳过结构标记:",g),l+=r.length+1;return}const E=W(g);if(E){let D=0;for(const q of n)if(q.char>=l){D=q.time;break}e.push({time:D,text:E}),console.log(`添加歌词行 ${c+1}: "${E}" 时间: ${D}s`)}l+=r.length+1}),e.sort((r,c)=>r.time-c.time),console.log("最终歌词数组（已排序）:",e),e},W=t=>t.replace(/[，。！？,;:.!?；：]/g,"").trim(),V=t=>{const e=t.trim();if(e.startsWith("[")&&e.endsWith("]")||e.startsWith("{")&&e.endsWith("}"))return console.log("检测到结构标记（括号）:",e),!0;const s=["verse","chorus","hook","bridge","intro","outro","pre-chorus","refrain","breakdown","drop"],n=e.toLowerCase();return s.some(i=>{const l=n.includes(i)||n.startsWith(i)||new RegExp(`\\b${i}\\b`,"i").test(e);return l&&console.log("检测到结构标记（关键词）:",e,"匹配:",i),l})},G=async t=>{var e,s,n,v;if(t){if(x.has(t)){console.log("使用缓存的歌词数据:",t),d.value=x.get(t)||[];return}try{$.value=!0,console.log("获取歌词时间线，musicId:",t);const i=await _e(t);if(((s=(e=i.data)==null?void 0:e.alignment)==null?void 0:s.length)>0){const l=i.data.alignment.filter(c=>c.success&&c.word.trim());console.log("原始API数据:",l.map(c=>c.word));const r=j(l);x.set(t,r),d.value=r,console.log("成功获取歌词时间线并缓存:",r)}else if(console.log("API返回的歌词数据为空，使用备用解析方法"),(n=a.value)!=null&&n.prompt){const l=C(a.value.prompt);x.set(t,l),d.value=l}}catch(i){if(console.error("获取歌词时间线失败:",i),(v=a.value)!=null&&v.prompt){const l=C(a.value.prompt);x.set(t,l),d.value=l}}finally{$.value=!1}}},C=t=>{if(!t)return[];let e=t;try{const l=JSON.parse(t);l.lyrics&&(e=l.lyrics,console.log("检测到JSON格式，提取lyrics字段:",e))}catch{console.log("不是JSON格式，使用原始文本解析歌词")}e=e.replace(/^["']|["']$/g,"").replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/^\s*{\s*$|^\s*}\s*$/gm,"").replace(/^\s*"title"\s*:\s*"[^"]*"\s*,?\s*$/gm,"").replace(/^\s*"lyrics"\s*:\s*"?/gm,"").replace(/,?\s*$/gm,"").replace(/"\s*$/gm,"").trim();const s=e.split(`
`),n=[];let v=0;const i=3;return s.forEach(l=>{const r=l.trim();if(!r)return;if(r.match(/^["']|["']$|^{\s*$|^}\s*$|"title"|"lyrics"/)){console.log("备用方法跳过JSON元素:",r);return}if(V(r)){console.log("备用方法跳过结构标记:",r);return}const c=W(r);c&&(n.push({time:v,text:c}),v+=i,console.log("备用方法添加歌词行:",c))}),console.log("备用方法最终歌词数组:",n),n},A=()=>{h.value=!h.value,h.value&&(y.value=-1,console.log("显示歌词，重置高亮索引"))},H=()=>{if(!h.value||d.value.length===0||w.value)return;const t=_.value;let e=-1;for(let s=0;s<d.value.length&&t>=d.value[s].time;s++)e=s;if(e===-1){y.value!==-1&&(y.value=-1,console.log(`时间 ${t.toFixed(1)}s: 无歌词高亮`));return}if(e!==y.value){const s=y.value;y.value=e,console.log(`时间 ${t.toFixed(1)}s: 歌词高亮从第${s+1}行切换到第${e+1}行: "${d.value[e].text}"`),P.value||he(()=>{const n=document.querySelector(".lyric-line.active");n&&n.scrollIntoView({behavior:"smooth",block:"center"})})}},X=()=>{P.value=!0,S.value&&clearTimeout(S.value),S.value=window.setTimeout(()=>{P.value=!1},3e3)};ce(async()=>{var t,e;if(z.query.musicData)try{if(a.value=JSON.parse(z.query.musicData),console.log("音乐数据:",a.value),(t=a.value)!=null&&t.musicId)await G(a.value.musicId);else if((e=a.value)!=null&&e.prompt){const s=C(a.value.prompt);d.value=s,console.log("使用备用方法解析的歌词:",s)}}catch(s){console.error("解析音乐数据失败:",s)}a.value||(a.value={title:"夜行人",artist:"LoneIN",imageUrl:"/api/placeholder/300/300",audioUrl:"/api/placeholder/audio.mp3"})});const Q=()=>{const t=ke.getChatPageState();t.conversationId?R.push(`/chat/${t.conversationId}`):R.back()},Y=()=>{f.value&&(b.value?f.value.pause():f.value.play(),b.value=!b.value)},Z=()=>{console.log("上一首")},ee=()=>{console.log("下一首")},te=()=>{f.value&&(_.value=f.value.currentTime,H())},se=()=>{f.value&&(k.value=f.value.duration)},oe=()=>{b.value=!1,_.value=0},F=t=>{const e=Math.floor(t/60),s=Math.floor(t%60);return`${e}:${s.toString().padStart(2,"0")}`},B=t=>{if(!M.value)return 0;const e=M.value.getBoundingClientRect(),s=t.clientX-e.left,n=e.width;return Math.max(0,Math.min(100,s/n*100))},J=t=>{if(!f.value||k.value===0)return;const e=t/100*k.value;f.value.currentTime=e,_.value=e},le=t=>{const e=B(t);J(e)},O=t=>{w.value=!0,T.value=B(t);const e=n=>{w.value&&(T.value=B(n))},s=()=>{w.value&&(J(T.value),w.value=!1),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",s)},ne=t=>{t.preventDefault(),O(t)};return(t,e)=>{var s,n,v,i,l,r;return m(),p("div",be,[o("div",{class:"background-cover",style:I({backgroundImage:`url(${(s=a.value)==null?void 0:s.imageUrl})`})},[...e[0]||(e[0]=[o("div",{class:"background-overlay"},null,-1)])],4),o("div",Le,[o("button",{class:"nav-btn back-btn",onClick:Q},[ie(ue(we),{size:20,color:"white"})])]),o("div",xe,[o("div",Te,[h.value?N("",!0):(m(),p("div",{key:0,class:"large-cover",onClick:A},[o("img",{src:(n=a.value)==null?void 0:n.imageUrl,alt:(v=a.value)==null?void 0:v.title},null,8,Me)])),h.value?(m(),p("div",{key:1,class:"lyrics-display",onClick:A,onScroll:X,ref_key:"lyricsDisplayRef",ref:K},[$.value?(m(),p("div",$e,[...e[1]||(e[1]=[o("p",null,"正在获取歌词时间线...",-1)])])):d.value.length===0?(m(),p("div",Pe,[...e[2]||(e[2]=[o("p",null,"暂无歌词",-1),o("p",{class:"no-lyrics-tip"},"点击此处关闭歌词",-1)])])):(m(),p("div",Se,[(m(!0),p(ve,null,de(d.value,(c,g)=>(m(),p("div",{key:g,class:fe(["lyric-line",{active:g===y.value}])},L(c.text),3))),128))]))],544)):N("",!0),h.value?N("",!0):(m(),p("div",Ce,[o("h1",Be,L(((i=a.value)==null?void 0:i.title)||"夜行人"),1),o("p",Ee,L(((l=a.value)==null?void 0:l.artist)||"LoneIN"),1)]))]),o("div",De,[o("span",Ie,L(F(_.value)),1),o("div",{class:"progress-bar",ref_key:"progressBarRef",ref:M,onClick:le,onMousedown:O},[o("div",{class:"progress-fill",style:I({width:U.value+"%"})},null,4),o("div",{class:"progress-thumb",style:I({left:U.value+"%"}),onMousedown:ge(ne,["stop"])},null,36)],544),o("span",Ne,L(F(k.value)),1)]),o("div",Re,[o("button",{class:"control-btn prev-btn",onClick:Z},[...e[3]||(e[3]=[o("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"white",stroke:"none"},[o("path",{d:"M6 6h2v12H6zm3.5 6l8.5 6V6z"})],-1)])]),o("button",{class:"control-btn play-pause-btn",onClick:Y},[b.value?(m(),p("svg",Ue,[...e[5]||(e[5]=[o("rect",{x:"6",y:"4",width:"4",height:"16"},null,-1),o("rect",{x:"14",y:"4",width:"4",height:"16"},null,-1)])])):(m(),p("svg",ze,[...e[4]||(e[4]=[o("path",{d:"M8 5v14l11-7z"},null,-1)])]))]),o("button",{class:"control-btn next-btn",onClick:ee},[...e[6]||(e[6]=[o("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"white",stroke:"none"},[o("path",{d:"M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"})],-1)])])])]),o("audio",{ref_key:"audioPlayer",ref:f,src:(r=a.value)==null?void 0:r.audioUrl,onTimeupdate:te,onLoadedmetadata:se,onEnded:oe},null,40,We)])}}});const je=ye(Ve,[["__scopeId","data-v-4c1d77a8"]]);export{je as default};
